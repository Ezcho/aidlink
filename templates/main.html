{% extends 'base.html' %}
{% block content %}
    <div id="map" style="width:100%;height:100vh;"></div>
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=29dab7759b80c1a6d8a5f31d57792672"></script>
    <script>
        var container = document.getElementById('map');
        var options = {
            center: new kakao.maps.LatLng(37.54273790670916,126.96719661395241), // 기본 좌표 (서울 시청)
            level: 3
        };

        var map = new kakao.maps.Map(container, options);

        // 현재 위치를 받아오고 지도의 중심을 설정하는 함수
        function setCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    var latitude = position.coords.latitude; // 현재 위도
                    var longitude = position.coords.longitude; // 현재 경도

                    var locPosition = new kakao.maps.LatLng(latitude, longitude);

                    map.setCenter(locPosition);
                }, function(error) {
                    console.error('Geolocation error:', error);
                });
            } else {
                console.error('Geolocation is not supported by this browser.');
            }
        }

        // setCurrentLocation 함수 호출
        setCurrentLocation();

		var locations = JSON.parse('{{ hospital_data_json|escapejs|safe }}');

		function displayMarkers() {
			for (var i = 0; i < locations.length; i++) {
				var markerPosition = new kakao.maps.LatLng(locations[i].latitude.toFixed(6), locations[i].longitude.toFixed(6));

				var marker = new kakao.maps.Marker({
					position: markerPosition,
				});

				marker.setMap(null);

				// 클로저를 사용하여 마커별로 오버레이를 생성하도록 수정
				(function(marker, content) {
            		kakao.maps.event.addListener(marker, 'click', function() {
                		var overlay = new kakao.maps.CustomOverlay({
							content: content,
							map: map,
							position: marker.getPosition()
					});
            	});
        	})(marker, createContent(locations[i])); // 오버레이에 표시될 내용을 생성하는 함수 호출
		}
	}

    displayMarkers();

	function createContent(location) {
		// 오버레이에 표시될 내용을 동적으로 생성
		var content = '<div style="padding:5px;">' +
			location.title + (location.center_type === "0" ? "(응급)" : "(외상)") +
			'<div style="float:right;"><button onclick="closeOverlay()">X</button></div>' +
			'<div>' + location.duty_addr +
			'<div>대표 : ' + location.duty_tel1 +
			'<div>응급실 : ' + location.duty_tel3 +
			'</div></div></div></div>';
    	return content;
	}

	function closeOverlay() {
		// 오버레이를 닫는 함수
		overlay.setMap(null);
	}

    </script>
{% endblock %}

